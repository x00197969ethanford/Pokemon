@page "/matchme"
@using pokemon_project.Data
@inject PokemonService PokemonService

<h3>Find Your Pokémon Twin</h3>

<div class="card p-3 mb-3">
    <div class="mb-2">
        <label>Your Height</label>

        <!-- Input cm -->
        <div class="d-flex gap-2">           
            <InputNumber @bind-Value="heightCm" class="form-control" style="width: 120px"/>
            <small>cm</small>
        </div>

    </div>
    <!-- Input weight -->
    <div class="mb-2">
        <label>Your Weight (kg)</label>
        <InputNumber @bind-Value="weightKg" class="form-control" style="width: 120px"/>
    </div>

    <button class="btn btn-primary" @onclick="FindMatch">Find My Pokémon</button>
</div>

<!-- Handle error and empty -->
@if (isLoading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}
else if (bestMatch != null)
{
    <!-- Display main match -->
    <div class="card p-3 mb-4">
        <h4>Your Closest Match: <span class="text-capitalize">@bestMatch.Name</span></h4>

        <img src="@bestMatch.Sprites.FrontDefault" style="width:150px" />

        <p><strong>Height:</strong>@(bestMatch.Height * 10) cm</p>
        <p><strong>Weight:</strong>@(bestMatch.Weight / 10.0) kg</p>
    </div>

    <h5>Top 3 Matches</h5>
    <p>The lower the score the closer the match!</p>

    <div>
        <!-- Display top 3 -->
        @foreach ((Pokemon match, double score) matches in top3)
        {
            <div class="card p-3" style="width: 200px;">
                <h6>@matches.match.Name</h6>

                <p>
                    <strong>Height:</strong> @(matches.match.Height * 10) cm
                </p>
                <p>
                    <strong>Weight:</strong> @(matches.match.Weight / 10.0) kg
                </p>
                <p>
                    <strong>Score:</strong> @matches.score
                </p>
            </div>
        }
    </div>
}


@code {
    double heightCm;
    double weightKg;

    bool isLoading = false;
    string? error = null;

    Pokemon? bestMatch;
    List<(Pokemon match, double score)> top3 = new List<(Pokemon match, double score)>();
    private async Task FindMatch()
    {
        error = null;
        bestMatch = null;
        top3 = new List<(Pokemon match, double score)>();

        isLoading = true;

        List<Pokemon>? list = await PokemonService.GetManyPokemonAsync(count: 100); // 100 faster for testing 

        (Pokemon best, List<(Pokemon match, double score)> top3) result = PokemonService.FindClosestMatches(list, heightCm, weightKg);

        bestMatch = result.best;
        top3 = result.top3;

        isLoading = false;
    }
}