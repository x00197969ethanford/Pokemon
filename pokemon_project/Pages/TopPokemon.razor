@page "/top12"
@using pokemon_project.Data
@inject PokemonService PokemonService
@inject NavigationManager Nav

<h3>Top 10 Pokémon</h3>

<div class="card p-3 mb-3">
    <h5>Filter by Stats</h5>

    <div class="row g-2">
        <div class="col-6 col-md-3">
            <label>Min HP</label>
            <InputNumber @bind-Value="minHp" class="form-control" min="0" max="9999" />
        </div>

        <div class="col-6 col-md-3">
            <label>Min Attack</label>
            <InputNumber @bind-Value="minAttack" class="form-control" min="0" max="9999"/>
        </div>

        <div class="col-6 col-md-3">
            <label>Min Defense</label>
            <InputNumber @bind-Value="minDefense" class="form-control" min="0" max="9999"/>
        </div>

        <div class="col-6 col-md-3">
            <label>Min Speed</label>
            <InputNumber @bind-Value="minSpeed" class="form-control" min="0" max="9999"/>
        </div>
    </div>

    <div class="mt-3">
        <label><strong>Sort by:</strong></label>
        <select class="form-select w-auto d-inline-block" @bind="sortBy">
            <option value="name">Name</option>
            <option value="hp">HP</option>
            <option value="attack">Attack</option>
            <option value="defense">Defense</option>
            <option value="speed">Speed</option>
            <option value="weight">Weight</option>
            <option value="height">Height</option>    
        </select>
        
        <button class="btn btn-secondary ms-2" @onclick="ToggleSort">
            @(sortAsc ? "Ascending" : "Descending")
        </button>
        
        <button class="btn btn-primary ms-3" @onclick="ApplyFilters">
            Apply Filters 
        </button>
    </div>
</div>

@if (isLoading)
{
    <p>Loading Pokémon...</p>
}
else
{
    <div class="d-flex flex-wrap gap-3">
        @foreach (Pokemon p in filtered)
        {
            <div class="card p-3" style="width: 270px;">
                <h5 class="text-capitalize text-center">@p.Name</h5>

                @if (!string.IsNullOrEmpty(p.Sprites.FrontDefault))
                {
                    <img class="mx-auto d-block" style="width:140px" src="@p.Sprites.FrontDefault" />
                }

                <p class="text-center mb-0"><strong>HP:</strong> @Stat(p, statName: "hp")</p>
                <p class="text-center mb-0"><strong>ATK:</strong> @Stat(p, statName: "attack")</p>
                <p class="text-center mb-0"><strong>DEF:</strong> @Stat(p, statName: "defense")</p>
                <p class="text-center mb-2"><strong>SPD:</strong> @Stat(p, statName: "speed")</p>

                <NavLink class="btn btn-primary btn-sm mx-auto" href="@($"{Nav.BaseUri}pokemon/{p.Name}")">
                    View
                </NavLink>

            </div>
        }
    </div>
}



@code {
    List<Pokemon> all = new List<Pokemon>();
    List<Pokemon> filtered = new List<Pokemon>();

    bool isLoading = true;

    int minHp = 0;
    int minAttack = 0;
    int minDefense = 0;
    int minSpeed = 0;

    string sortBy = "hp";
    bool sortAsc = false; // best first

    protected override async Task OnInitializedAsync()
    {
        all = await PokemonService.GetManyPokemonAsync(count: 898); // was 100 for testing
        ApplyFilters();
        isLoading = false;
    }

    int Stat(Pokemon p, string statName)
    {
        foreach (PokemonStat data in p.Stats)
        {
            if (data.Stat.Name == statName)
            {
                return data.BaseStat;
            }
        }
        return 0;
    }

    void ToggleSort()
    {
        sortAsc = !sortAsc;
        ApplyFilters();
    }

    void ApplyFilters()
    {
        IEnumerable<Pokemon> result = all;

        result = FilterByStats(result);

        result = SortResults(result);

        filtered = result.Take(count: 12).ToList();

        StateHasChanged();
    }

    IEnumerable<Pokemon> FilterByStats(IEnumerable<Pokemon> list)
    {
        return list.Where(p =>
        Stat(p, statName: "hp") >= minHp &&
        Stat(p, statName: "attack") >= minAttack &&
        Stat(p, statName: "defense") >= minDefense &&
        Stat(p, statName: "speed") >= minSpeed
        );
    }

    IEnumerable<Pokemon> SortResults(IEnumerable<Pokemon> list)
    {
        if (sortBy == "hp")
            return sortAsc ? list.OrderBy(p => Stat(p, statName: "hp")) : list.OrderByDescending(p => Stat(p, statName: "hp"));

        if (sortBy == "attack")
            return sortAsc ? list.OrderBy(p => Stat(p, statName: "attack")) : list.OrderByDescending(p => Stat(p, statName:
            "attack"));

        if (sortBy == "defense")
            return sortAsc ? list.OrderBy(p => Stat(p, statName: "defense")) : list.OrderByDescending(p => Stat(p, statName:
            "defense"));

        if (sortBy == "speed")
            return sortAsc ? list.OrderBy(p => Stat(p, statName: "speed")) : list.OrderByDescending(p => Stat(p, statName:
            "speed"));

        if (sortBy == "height")
            return sortAsc ? list.OrderBy(p => p.Height) : list.OrderByDescending(p => p.Height);

        if (sortBy == "weight")
            return sortAsc ? list.OrderBy(p => p.Weight) : list.OrderByDescending(p => p.Weight);

        return sortAsc ? list.OrderBy(p => p.Name) : list.OrderByDescending(p => p.Name);
    }

}
